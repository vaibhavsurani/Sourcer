// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  companyName   String?
  companyLogo   String?
  phoneNumber   String?
  role          UserRole  @default(EMPLOYEE)
  hrId          String?
  employeeId    String?   @unique
  isPasswordChanged Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Profile fields
  jobPosition          String?
  department           String?
  manager              String?
  location             String?
  dateOfBirth          DateTime?
  residingAddress      String?
  nationality          String?
  personalEmail        String?
  gender               String?
  maritalStatus        String?
  dateOfJoining        DateTime?
  accountNumber        String?
  bankName             String?
  ifscCode             String?
  panNo                String?
  uanNo                String?
  emergencyContactName String?
  emergencyContactPhone String?
  emergencyContactRelation String?
  skills               String?
  experience           String?
  education            String?
  certifications       String?
  languages            String?
  resumeFile           String?

  // Salary fields
  monthlyWage          Float?
  yearlyWage           Float?
  workingDaysPerWeek   Int?
  breakTimeHours       Float?
  basicSalary          Float?
  basicSalaryPercent   Float?
  hra                  Float?
  hraPercent           Float?
  standardAllowance    Float?
  standardAllowancePercent Float?
  performanceBonus     Float?
  performanceBonusPercent Float?
  lta                  Float?
  ltaPercent           Float?
  fixedAllowance       Float?
  fixedAllowancePercent Float?
  employeePF           Float?
  employeePFPercent    Float?
  employerPF           Float?
  employerPFPercent    Float?
  professionalTax      Float?

  accounts Account[]
  sessions Session[]
  employees User[] @relation("HREmployees")
  hr User? @relation("HREmployees", fields: [hrId], references: [id], onDelete: SetNull)
  attendances Attendance[]
  timeOffs TimeOff[]
  approvedTimeOffs TimeOff[] @relation("TimeOffApprovals")
  rejectedTimeOffs TimeOff[] @relation("TimeOffRejections")
}

enum UserRole {
  HR
  EMPLOYEE
}


model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}


model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model token {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  type    TokenTypes
  expires   DateTime
  
   @@unique([email, token, type])
  @@index([email, type])
}

enum TokenTypes {
  EmailVerification
  PasswordReset
}

// Attendance model
model Attendance {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  workHours   Float?   // in hours
  extraHours  Float?   // in hours
  breakHours  Float?   // in hours
  status      AttendanceStatus @default(PRESENT)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  HALF_DAY
}

// TimeOff model
model TimeOff {
  id            String        @id @default(cuid())
  userId        String
  timeOffType   TimeOffType
  startDate     DateTime      @db.Date
  endDate       DateTime      @db.Date
  days          Float
  status        TimeOffStatus @default(PENDING)
  attachment    String?
  notes         String?
  approvedBy    String?
  approvedAt    DateTime?
  rejectedBy    String?
  rejectedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver User? @relation("TimeOffApprovals", fields: [approvedBy], references: [id], onDelete: SetNull)
  rejector User? @relation("TimeOffRejections", fields: [rejectedBy], references: [id], onDelete: SetNull)

  @@index([userId, startDate])
  @@index([status])
  @@index([timeOffType])
}

enum TimeOffType {
  PAID_TIME_OFF
  SICK_LEAVE
  UNPAID_LEAVE
}

enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
}

// Update User model to include time off relations